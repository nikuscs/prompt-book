name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: Version bump type
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  checks:
    name: Checks
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            apps/desktop-tauri/src-tauri

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Run checks
        run: bun run check

  create-tag:
    name: Create Tag
    needs: checks
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
      commit_sha: ${{ steps.commit.outputs.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify main branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::error::Release must be run from main branch, not ${{ github.ref }}"
            exit 1
          fi

      - name: Read current version
        id: current
        run: |
          VERSION=$(grep '^version = ' apps/desktop-tauri/src-tauri/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Bump version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ inputs.version_bump }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update version files
        run: |
          NEW_VERSION="${{ steps.bump.outputs.version }}"
          sed -i 's/^version = ".*"/version = "'"$NEW_VERSION"'"/' apps/desktop-tauri/src-tauri/Cargo.toml
          sed -i 's/"version": ".*"/"version": "'"$NEW_VERSION"'"/' apps/desktop-tauri/src-tauri/tauri.conf.json
          sed -i 's/"version": ".*"/"version": "'"$NEW_VERSION"'"/' apps/desktop-tauri/package.json

      - name: Commit and tag
        id: commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add apps/desktop-tauri/src-tauri/Cargo.toml apps/desktop-tauri/src-tauri/tauri.conf.json apps/desktop-tauri/package.json
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          git tag -a "${{ steps.bump.outputs.tag }}" -m "Release ${{ steps.bump.outputs.tag }}"
          git push origin main --follow-tags

  build-and-release:
    name: Build and Release (macOS)
    needs: create-tag
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-tag.outputs.tag }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.5

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            apps/desktop-tauri/src-tauri

      - name: Install deps
        run: bun install --frozen-lockfile

      - name: Build and release Tauri bundles
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ needs.create-tag.outputs.tag }}
          releaseName: PromptBook v__VERSION__
          releaseBody: |
            Desktop release for PromptBook.
          releaseDraft: false
          prerelease: false
          projectPath: apps/desktop-tauri
          args: ""

  cleanup:
    name: Cleanup on failure
    needs: [create-tag, build-and-release]
    if: failure() && needs.create-tag.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete tag and revert commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git push --delete origin ${{ needs.create-tag.outputs.tag }} || true

          git pull origin main
          git revert ${{ needs.create-tag.outputs.commit_sha }} --no-edit
          git push origin main
